<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <link rel="stylesheet" href="/static/css/main.css">
  </head>
  <body>

    <div class="custom-scrollbar-container">
      <div class="custom-scrollbar-track">
        <div class="custom-scrollbar-thumb" id="customScrollbarThumb"></div>
      </div>
    </div>

    <nav class="navbar dashboard-nav" role="navigation" aria-label="Main navigation">
      <a class="nav-expenses" data-bs-toggle="modal" data-bs-target="#expensesModal">Expenses</a>
      <a class="nav-loans" data-bs-toggle="modal" data-bs-target="#loansModal">Loans</a>
      <a class="nav-insurance" data-bs-toggle="modal" data-bs-target="#insuranceModal">Insurance</a>
      <a class="nav-logout" href="{{ url_for('auth.logout') }}">Logout</a>
    </nav>

    <div class="stack-v">
      <div class="glass-card text-center">
        <h2>Hello, {{ user.first_name }} ðŸ‘‹</h2>
        <p>Welcome to your dashboard!</p>
        <br /><br /><br />
        <h3>Overview</h3>
        <div class="row">
          <div class="col-12 col-lg-4 mb-3">
            <div class="p-2">Total Expenses</div>
            <div class="h5">{{ '%.2f'|format(total_expenses or 0) }}</div>
            <canvas style="height:125px;width: 100%;"></canvas>
          </div>
          <div class="col-12 col-lg-4 mb-3">
            <div class="p-2">Total Loans</div>
            <div class="h5">{{ '%.2f'|format(total_loans or 0) }}</div>
            <canvas style="height:125px;width: 100%;"></canvas>
          </div>
          <div class="col-12 col-lg-4 mb-3">
            <div class="p-2">Monthly Premiums</div>
            <div class="h5" style="width:100%;">{{ '%.2f'|format(total_premium or 0) }}</div>
            <canvas style="height:125px;width: 100%;"></canvas>
          </div>
        </div>
      </div>
    </div>

    {# import component macros #}
    {% import "components/modal.html" as Modal %}
    {% import "components/dropdown.html" as Dropdown %}
    {% import "components/table.html" as Table %}
    {% import "components/form.html" as Forms %}

    {# ========== EXPENSES MODAL ========== #}
    {% set expense_header_buttons %}
      <button class="btn btn-sm btn-custom" data-bs-toggle="modal" data-bs-target="#expenseFilterModal">Filter</button>
      <button class="btn btn-sm btn-custom" data-bs-toggle="modal" data-bs-target="#expenseFullModal">More Info</button>
      <button class="btn btn-sm btn-custom" data-bs-toggle="modal" data-bs-target="#expenseModal">Add</button>
    {% endset %}

    {{ Modal.render_modal(
        "expensesModal",
        "Expenses Overview",
        '<canvas id="expenseChart" style="height:350px; width:100%;"></canvas>',
        "lg",
        expense_header_buttons
    ) }}

    {# Expense Filter Modal (uses Dropdown.multiselect) #}
    {% set expense_filter_body %}
      <form method="get" action="{{ url_for('dashboard.dashboard') }}">
        {{ Dropdown.multiselect("Categories", DEFAULT_CATEGORIES, "expense_category", selected_expense_categories, "cat") }}
        <div class="row">
          <div class="col-6 mb-2">
            <label class="form-label"><strong>Start Date</strong></label>
            <input type="date" class="form-control" name="start_date" value="{{ start_date }}">
          </div>
          <div class="col-6 mb-2">
            <label class="form-label"><strong>End Date</strong></label>
            <input type="date" class="form-control" name="end_date" value="{{ end_date }}">
          </div>
        </div>
        <button type="submit" class="btn btn-custom mt-2">Apply</button>
      </form>
    {% endset %}

    {{ Modal.render_modal("expenseFilterModal", "Filter Expenses", expense_filter_body, "md", "", False, "expensesModal") }}

    {# Expense Full Modal (table). We need to pre-format rows similarly to original template. #}
    {% set expense_rows = [] %}
    {% for e in expenses %}
      {% set _ = expense_rows.append([
           (e.date.strftime('%Y-%m-%d') if e.date else ''),
           (e.category.name if e.category else ''),
           (e.description or ''),
           ('%.2f'|format(e.amount))
      ]) %}
    {% endfor %}
    {{ Table.full_table_modal("expenseFullModal", "expensesModal", "All Expenses",
         ["Date","Category","Description","Amount"], expense_rows,
         '%.2f'|format(expenses|sum(attribute='amount'))) }}

    {# Expense Add Modal - use form macro #}
    {{ Modal.render_modal("expenseModal", "Add Expense", Forms.expense_form(categories, url_for('dashboard.add_expense')), "lg", "", False, "expensesModal") }}


    {# ========== LOANS MODAL ========== #}
    {% set loan_header_buttons %}
      <button class="btn btn-sm btn-custom" data-bs-toggle="modal" data-bs-target="#loanFilterModal">Filter</button>
      <button class="btn btn-sm btn-custom" data-bs-toggle="modal" data-bs-target="#loanFullModal">More Info</button>
      <button class="btn btn-sm btn-custom" data-bs-toggle="modal" data-bs-target="#loanModal">Add</button>
    {% endset %}

    {{ Modal.render_modal("loansModal", "Loans Overview", '<canvas id="loanChart" style="height:400px; width:100%; cursor:pointer;"></canvas>', "lg", loan_header_buttons) }}

    {# Loan Filter Modal #}
    {% set loan_filter_body %}
      <form method="get" action="{{ url_for('dashboard.dashboard') }}">
        {{ Dropdown.multiselect("Lenders", lenders, "loan_lender", selected_loan_lenders, "lender") }}
        {{ Dropdown.multiselect("Loan Categories", loan_categories, "loan_category", selected_loan_categories, "loancat") }}
        <div class="row">
          <div class="col-6 mb-2">
            <label class="form-label"><strong>Start Date</strong></label>
            <input type="date" class="form-control" name="start_date" value="{{ start_date }}">
          </div>
          <div class="col-6 mb-2">
            <label class="form-label"><strong>End Date</strong></label>
            <input type="date" class="form-control" name="end_date" value="{{ end_date }}">
          </div>
        </div>
        <button class="btn btn-custom mt-2" type="submit">Apply</button>
      </form>
    {% endset %}

    {{ Modal.render_modal("loanFilterModal", "Filter Loans", loan_filter_body, "md", "", False, "loansModal") }}

    {# Loan Full Modal (table) #}
    {% set loan_rows = [] %}
    {% for l in loans %}
      {% set _ = loan_rows.append([
          (l.lender or ''),
          ('%.2f'|format(l.amount)),
          ('%.2f'|format(l.interest_rate or 0)),
          (l.due_date.strftime('%Y-%m-%d') if l.due_date else '')
      ]) %}
    {% endfor %}
    {{ Table.full_table_modal("loanFullModal", "loansModal", "All Loans", ["Lender","Amount","Interest %","Due Date"], loan_rows, '%.2f'|format(loans|sum(attribute='amount'))) }}

    {# Loan Add Modal #}
    {{ Modal.render_modal("loanModal", "Add Loan", Forms.loan_form(lenders, loan_categories, url_for('dashboard.add_loan')), "lg", "", False, "loansModal") }}


    {# ========== INSURANCE MODAL ========== #}
    {% set insurance_header_buttons %}
      <button class="btn btn-sm btn-custom" data-bs-toggle="modal" data-bs-target="#insuranceFilterModal">Filter</button>
      <button class="btn btn-sm btn-custom" data-bs-toggle="modal" data-bs-target="#insuranceFullModal">More Info</button>
      <button class="btn btn-sm btn-custom" data-bs-toggle="modal" data-bs-target="#insuranceModalAdd">Add</button>
    {% endset %}

    {{ Modal.render_modal("insuranceModal", "Insurance Overview", '<canvas id="insuranceChart" style="height:400px; width:100%; cursor:pointer;"></canvas>', "lg", insurance_header_buttons) }}

    {# Insurance Filter Modal #}
    {% set insurance_filter_body %}
      <form method="get" action="{{ url_for('dashboard.dashboard') }}">
        {{ Dropdown.multiselect("Providers", providers, "insurance_provider", selected_insurance_providers, "provider") }}
        {{ Dropdown.multiselect("Policy Types", POLICY_TYPES, "policy_type", selected_policy_types, "policy") }}
        <div class="row">
          <div class="col-6 mb-2">
            <label class="form-label"><strong>Start Date</strong></label>
            <input type="date" class="form-control" name="start_date" value="{{ start_date }}">
          </div>
          <div class="col-6 mb-2">
            <label class="form-label"><strong>End Date</strong></label>
            <input type="date" class="form-control" name="end_date" value="{{ end_date }}">
          </div>
        </div>
        <button class="btn btn-custom mt-2" type="submit">Apply</button>
      </form>
    {% endset %}

    {{ Modal.render_modal("insuranceFilterModal", "Filter Insurance", insurance_filter_body, "md", "", False, "insuranceModal") }}

    {# Insurance Full Modal (table) #}
    {% set insurance_rows = [] %}
    {% for ins in insurances %}
      {% set _ = insurance_rows.append([
          (ins.provider or ''),
          (ins.policy_type or ''),
          ('%.2f'|format(ins.premium)),
          (ins.renewal_date.strftime('%Y-%m-%d') if ins.renewal_date else '')
      ]) %}
    {% endfor %}
    {{ Table.full_table_modal("insuranceFullModal", "insuranceModal", "All Insurance Policies",
         ["Provider","Policy Type","Premium","Renewal Date"], insurance_rows, '%.2f'|format(insurances|sum(attribute='premium'))) }}

    {# Insurance Add Modal #}
    {{ Modal.render_modal("insuranceModalAdd", "Add Insurance", Forms.insurance_form(providers, POLICY_TYPES, url_for('dashboard.add_insurance')), "lg", "", False, "insuranceModal") }}


    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      window.dashboardData = {
        expenseData: {{ expense_chart_data | tojson | safe }},
        loanData: {{ loan_chart_data | tojson | safe }},
        insuranceData: {{ insurance_chart_data | tojson | safe }},
        categoryData: {{ category_chart_data | tojson | safe }}
      };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
  </body>
</html>
